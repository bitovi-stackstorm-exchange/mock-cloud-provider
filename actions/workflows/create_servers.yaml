version: 1.0

description: Create servers

input:
  - key_name
  - num_servers
vars:
  - server_id: ""

output:
  - server_id: <% ctx().server_id %>
  - servers: <% ctx().servers %>

tasks:

  generate_server_id:
    action: core.local
    input:
      cmd: "date +%s"
    next:
      - when: <% succeeded() %>
        publish:
          - serever_id: <% result().stdout %>
        do:
          - update_config

  update_config:
    action: mock_cloud_provider.update_config
    input:
      key_name: <% ctx().key_name %>
      server_id: <% ctx().server_id %>
      num_servers: <% ctx().num_servers %>
    next:
      - when: <% succeeded() %>
        publish:
          - servers: <% result().servers %>
        do:
          - notify
          
  notify:
    action: core.echo
    input:
      message: "New server created with id <% ctx().server_id %>. NumServers: <% ctx().num_servers %>"