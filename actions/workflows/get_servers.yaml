version: 1.0

description: Get servers

input:
  - server_id
  - key_name

output:
  - result: <% ctx().result %>
  - server_id: <% ctx().server_id %>

tasks:
  get_servers:
    action: st2.kv.get_object
    input:
      key: <% ctx().key_name %>
    next:
      - when: <% succeeded() and server_id = None %>
        publish:
          - result: <% result().result.servers %>
          - published: "notify"
        do:
          - notify
      - when: <% succeeded() and server_id != None %>
        publish:
          - servers: <% result().result.servers %>
          - published: "publish_server"
        do:
          - publish_server

  publish_server:
    action: core.noop
    next:
      - when: <% succeeded() %>
        publish:
          # result: <% ctx().servers.get(server_id) %>
          result: <% ctx().servers %>
        do:
          - notify

  notify:
    action: core.echo
    input:
      message: "Got server updated with id <% ctx().server_id %>."