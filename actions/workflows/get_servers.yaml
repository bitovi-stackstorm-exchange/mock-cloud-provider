version: 1.0

description: Get servers

input:
  - server_id
  - key_name

output:
  - data: <% ctx().data %>
  - server_id: <% ctx().server_id %>
  - published: <% ctx().published %>

tasks:
  get_servers:
    action: st2.kv.get_object
    input:
      key: <% ctx().key_name %>
    next:
      - when: <% succeeded() and ctx().server_id = null %>
        publish:
          - data: <% result().result %>
          - published: "notify"
      - when: <% succeeded() and ctx().server_id != null %>
        publish:
          - data: <% result().result %>
          - published: "publish_server"
  #       do:
  #         - publish_server

  # publish_server:
  #   action: core.noop
  #   next:
  #     - when: <% succeeded() %>
  #       publish:
  #         # data: <% ctx().servers.get(server_id) %>
  #         data: <% ctx().servers %>
  #       do:
  #         - notify